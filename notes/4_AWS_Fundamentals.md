# Section 4: AWS Fundamentals ELB + ASG + EBS
-how to scale an app in AWS

### Load Balancing Overview 
-load balancers (ELBs, EC2 load balancers)= server that will front my app --> forward all traffic to instances (multiple servers) downstream
-EC2 instances have our app --> users connect to load balancer and then balancer connects the user to one EC2 instnce on the backend--> user load is balancer between the EC2 instances so that one instance is not overwhelmed 
-WHY use? 
* scale instances downstream but with one point of access, therefore if an EC2 instance fails users can still connect to app 
* load balancer will do regular health checks on EC2 instances to see if they fail
* provides SSL termination (HTTPS) for the websites --> encryption is between client and ELB 
* enforces stickiness with cookies --> therefore user can connect to same EC2 via cookies 
* high availability across zones 
* separate private vs public traffic

ELBs = managed load balancers
-AWS says it will be working 
-AWS upgrades them, maintains them, highly available 
-AWS has them integrated with many AWS offerings/services
-AWS provides configs via UI 
-can set up own load balancer but it is more common to use the ELB from AWS

3 kinds of ELBs on AWS: 
1. **Classic Load Balancer** --> (v1 - old gen) -2009 
1. **Application Load Balancer** --> (v2 new gen) - 2016 
1. **Network Load Balancer** --> (v2 new gen) - 2017
-recommended to use v2 ELBs b/c more features 
-can set up either internal (private) or external (public) ELB

Health Checks
-crucial --> check traffic is healthy, that traffic is getting replies from requests to ELBs
-done on port and route --> /health is typical route
-if res !== 200 status then not healthy ELB 

**Application Load Balancers (ALBs) (v2)**
-aka Layer 7 b/c allow to work at HTTP level 
- load balance to multiple HTTP apps across machines (**target groups**)
- load balance to multiple apps on the same machine (**containers**)
-can load balance based on route in url or based on hostname in url 
-awesome for microservices and container-based app (e.g. Docker and Amazon ECS)
-port mapping feature to redirect to dynamic port --> allows to redirect to same instance on the same machine

-before we would need to create one classic load balancers / app --> inefficient! expensive!

ALB good to know: 
* Stickiness can be enabled at the target group level --> same user to same instance --> stickiness generated by ALB itself, not the app
* ALBs support HTTP, HTTPS and websockets protocols 
* app servers don't see the IP of the client directly since it's via ALB (trye IP of the client is inserted in the header X-Forwarded-For Header, can also get the port X-Forwarded-Port and proto at X-Forwarded-Proto)

Client IP --> talks to ALB --> ALB does connection termination (terminates client direct connection) --> ALB has a private IP that connects to an EC2 instance

**Network Load Balancers (v2)**
- Layer 4 --> for TCP traffic to instances
- Handle millions of requests/seconds
- Support static or elastic IPs
- High performance 
- Less latency (100ms) than ALBs (400ms)
- can see the client IP

-mostly used for extreme performance, not default LB of choice 
-generally same process as ALB but with TCP traffic 

LBs general good to know: 
* classic LB deprecated 
* ALBs for HTTP / HTTPs and websocket
* NLBs for TCP 
* CLB and ALB support SSL certificates, provides SSL termination 
* all LB can do health checks, all have static hostnames --> get a URL that the app will use --> should not resolve the URL and use the underlying IP 
* ALB can route via hostname or path 
* ALB good with ECS (Docker)
* LBs can scale but not instantaneously 
* res with 4xx = client-induced errors
* res with 5xx = app-induced errors (503 = LB at capacity or no registered targets)
* if LB can't connect to app ==> check security groups 

### LBs Hands On 
-go to Load Balancer tab on AWS --> create ALB with Scheme internet-facing because we want it to be public --> IPv4
-Listeners = list of Ports that we will listen on --> want Port 80 with HTTP protocol 
-Configure a new Security Group to handle the ALB --> make it type HTTP, protocol TCP, Port 80 source all (0s)
-Configure routing --> create a new target group --> HTTP port 80 b/c our instance is accessible for that port --> health check will be HTTP at path / (don't have a /health route) (can customize health check if you want)
-Register Targets --> add the instance to the registered Targets
-create LB 

-wait for provisioning --> then make sure everything works
-could go straight to the DNS name and copy into browser --> should see the Apache web app we created! 
-ALB makes the DNS name --> never going to change, internet facing

Trick with Security Groups: allow LB to access EC2 instance and nothing else (via the fact that Security Groups can reference Security Groups)!
* go to Security Groups --> want to allow inbound traffic of Security Group only coming from the LB! 
* Edit Inbound Rule for Security Group and delete the 0s that indicate we can access EC2 directly via IP --> now only via load balancer
* therefore, a very secure set up because we know that only the LB can talk to EC2 on port 80 